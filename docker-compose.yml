version: '3'

services:
  elasticsearch: # Elasticsearch Instance
    container_name: es-search-api
    image: docker.elastic.co/elasticsearch/elasticsearch:6.1.1
    volumes: # Persist ES data in seperate "esdata" volume
      - $ES_DATA_PATH:/usr/share/elasticsearch/data
    environment:
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      - discovery.type=single-node
    ulimits:
      memlock:
        soft: -1
        hard: -1
    ports: # Expose ElasticSearch ports
      - "9300:9300"
      - "9200:9200"

  api:
    container_name: node-react-api
    # build:  # it will look for Dockerfile in current directory to build the image
    #   context: .
    #   dockerfile: Dockerfile
    image: nyuvis/ela-helper-web-app:1.0.1
    ports:
      - "3000:3000" # Expose App port
    restart: on-failure
    volumes:
      - /app/server/node_modules # Inside the container, don't try to override this folder, just leave as is
      - $RUNTIME/nlp-data:/app/server/nlpData
      - $RUNTIME/projections:/app/server/projections
    stdin_open: true
    tty: true
    command: npm run start
    environment: # Set ENV vars
     - NODE_ENV=local
     - DOC_FOLDER_NAME=nlpData
     - TOPICS_FOLDER=projections
     - ES_HOST=elasticsearch
     - PORT=3000
    depends_on: 
      - texas-api

  texas-api:
    container_name: texas-api
    image: nyuvis/texas-web-app:1.0.0
    environment:
      ES_DEFAULT_HOST: $ES_DEFAULT_HOST
      ES_DEFAULT_PORT: $ES_DEFAULT_PORT
      ES_DEFAULT_PATH: $ES_DEFAULT_PATH
    # build:
    #   context: ./texas
    #   dockerfile: ./apps/texas-server/Dockerfile
    #   args:
    #   - API_PORT
    #   - AUTH_SECRET
    ports:
    - $API_PORT:$API_PORT
    - "5555:5555"
    - "5556:5556"
    
    volumes:
    - ./texas:/app
    - $RUNTIME/data:/data
    - $RUNTIME/projections:/nlp/projections
    
    - /app/node_modules
    - /app/apps/texas-server/node_modules
    - /app/apps/texas-cli/node_modules
    - /app/lib/texas-js/node_modules
    - /app/lib/texas-utils/node_modules
    - /app/lib/texas-gql/node_modules
    stdin_open: true
    tty: true
    command: npm start
  
  texas-nlp:
    # build:
    #   context: ./texas-nlp/texas
    #   args:
    #     - LIBS
    
    image: nyuvis/texas-nlp-app:1.0.0
    environment:
      JUPYTER_PORT: $JUPYTER_PORT
      ES_DEFAULT_HOST: $ES_DEFAULT_HOST
      ES_DEFAULT_PORT: $ES_DEFAULT_PORT
      ES_DEFAULT_PATH: $ES_DEFAULT_PATH
      TEXAS_DEFAULT_URL: $TEXAS_DEFAULT_URL
    stdin_open: true
    tty: true
    container_name: texas-nlp
    volumes:
      - $NLP_DATA:/data
      - $NLP_DATA:/app/data
      - ./texas-nlp/texas:/app/texas
      - $NOTEBOOKS:/app/notebooks
      - $RUNTIME/projections:/nlp/projections
    command: python /app/texas/server/server.py
    ports:
      - $JUPYTER_PORT:8888

# volumes: 
#   esdata:$ES_DATA_PATH
  